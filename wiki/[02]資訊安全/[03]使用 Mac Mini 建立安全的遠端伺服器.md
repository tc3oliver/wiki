# 使用 Mac Mini 建立安全的遠端伺服器

最近我入手了一台 Mac Mini 要當成家裡的小伺服器玩玩。雖然買台小型電腦當伺服器玩還蠻多人在做,但其實要把它弄得安全也是一門學問。所以我想跟各位分享一下我的設定步驟,希望對大家也有幫助。但在這之前，讓我先分享一下我購買 Mac Mini 的經驗和比較。

我選了一台基本款的 M2 Mac Mini,是用 BTS 方案買的,只要1.5萬7出頭就搞定了,然後還送了一副 AirPods 2, CP 值滿高的。這台配備 8核心 CPU、10核心 GPU、8GB 記憶體和 256GB SSD,用的是新出的 M2 晶片,效能出色又省電。正因為它效能強、發熱低,也讓我覺得它當小伺服器再適合不過了。

相較那些雲端服務,一個月就要繳好幾千塊,自己架一台小伺服器算是很划算。我查了一下,在 Scaleway 網站上，他們提供了使用 Apple M1 晶片的雲主機，每小時價格約為 0.11 歐元。而在 Azure 或 AWS 上使用類似配置的主機，每年的費用接近 10 萬台幣。考量成本和效能,我覺得還是自己買個 Mac Mini 當伺服器最划算。

這款 Mac Mini 不只價格 ok,它還有著超低功率耗電、發熱又低的優點,讓我可以長時間運作,一舉兩得。所以各方面考量下來,我覺得它當我的小伺服器再適合不過了!

此外,M2 晶片使用了統一記憶體架構,讓我能把 Mac Mini 當成擁有 8GB 顯存的顯卡來用,對我未來想部署需要大量記憶體的 AI 模型時將會很有幫助。

那接下來,我要和各位分享一下我為了強化 Mac Mini 安全性所做的一些設定。

## 1. 產生 SSH 金鑰對

首先，在我的本地機器上，我使用以下命令生成了 SSH 金鑰對：

```bash
ssh-keygen -t rsa -b 4096 -C "your_email@example.com"
```

這個命令生成了一個新的 RSA 金鑰對，並以我的電子郵件地址作為標籤。為了增加安全性，我選擇了 4096 位的金鑰長度。

系統會要求我指定金鑰的儲存位置，我選擇了預設的位置（通常是 `~/.ssh/id_rsa`）。

## 2. 將公鑰複製到遠程主機

有了 SSH 金鑰對後，我將公鑰複製到我的 Mac Mini。我使用以下命令：

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub user@host
```

這個命令將我的公鑰複製到遠程主機的 `~/.ssh/authorized_keys` 文件中。輸入遠程主機的密碼驗證後，公鑰就會被成功複製到主機上。

## 3. SSH 安全設定

為了提高 SSH 的安全性，我修改了 `/etc/ssh/sshd_config` 文件的設定。

我使用以下命令打開該文件：

```bash
sudo nano /etc/ssh/sshd_config
```

在文件中，我新增或修改了以下行：

```text
PubkeyAuthentication yes
PasswordAuthentication no
ChallengeResponseAuthentication no
```

這些設定將 SSH 設置為只接受公鑰認證，禁止使用密碼登入和挑戰回應驗證。這提高了伺服器的安全性。

另外，我還將 SSH 的默認端口從 22 改為一個非標準端口。這樣做可以防止許多針對標準 SSH 端口的自動化攻擊。

## 4. 更改 SSH 預設端口

在 `sshd_config` 文件

中，找到 `#Port 22` 這一行，刪除 `#` 並

將 `22` 改為你想要的端口。同時，在 `/etc/services` 文件中對應地更改端口：

```bash
sudo nano /etc/services
```

找到 `ssh 22/tcp` 這一行，將 `22` 改為你在 `sshd_config` 文件中設定的新端口。

## 5. VNC 只接受本地連接

為了增加 VNC 的安全性，我將其設置為只接受本地主機的連接。我使用了以下命令：

```bash
sudo defaults write /Library/Preferences/com.apple.RemoteManagement.plist VNCOnlyLocalConnections -bool yes
```

這個命令將 `VNCOnlyLocalConnections` 的值設置為 `yes`，表示 macOS 只接受來自本地主機的 VNC 連接。

## 6. SSH 隧道

為了安全地訪問 VNC，我建立了一個 SSH 隧道。以下是具體的操作步驟：

```bash
ssh -L 5900:localhost:5900 user@host -p port
```

這個命令將本地的 5900 端口映射到遠程主機的 5900 端口，所有的 VNC 數據將通過加密的 SSH 隧道進行傳輸，這樣可以防止數據在網路上被攔截或竊取。

## 7. SMB 安全設定

為什麼我會選擇使用 SMB(Server Message Block)傳輸檔案呢?

SMB 是一種網路檔案共享協定,它允許不同的設備透過網路互相存取檔案和資料夾。與傳統的 FTP 不同,SMB 的速度更快,安全性也較高。

為了增加 SMB 的安全性，我也通過 SSH 隧道進行設定。以下是具體的操作步驟：

```bash
ssh -L 8445:localhost:445 user@host -p port
```

這個命令將本地的 8445 端口映射到遠程主機的 445 端口，所有的 SMB 數據將通過加密的 SSH 隧道進行傳輸，這樣可以防止數據在網路上被攔截或竊取。

這樣一來,所有 SMB 資料就會經由加密的 SSH 隧道安全地傳輸,有效防止資料被攔截。

而且我在 Mac Mini 掛載 4TB SSD 作為存儲設備, 這樣既增加了存儲空間, 也提高了傳輸速度與效能。

## 8. 配置防火牆

最後，為了進一步加強安全性，我使用 Murus Lite 工具來配置 macOS 內建的防火牆。我將所有的 TCP 和 UDP 連接預設為封鎖狀態，然後只允許特定的連接通過：

- 允許來自本地主機的 VNC 和 SMB 連接
- 開放 80 和 443 端口，以提供 HTTP 和 HTTPS 服務

透過這些設定,我覺得我的 Mac Mini 小伺服器已經變得蠻安全了!把 SSH、VNC、SMB 都用加密通道對接,應該可以防止被入侵或竊聽。當然資訊安全是需要持續強化的,大家可以定期回來更新系統和工具。如果有興趣還可以玩玩防火牆或入侵偵測系統,讓安全性更上一層樓。
今天就先分享到這邊,希望對想要架自己小伺服器的兄弟們有所幫助!安全設定是門大學問,有任何問題歡迎留言討論,我會盡力提供意見!祝各位成功部署出安全又穩定的家用小伺服器!
